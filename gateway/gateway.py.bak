import paho.mqtt.client as mqtt
import json
import requests
import time

broker = 'localhost'
port = 1883
topic_sub = 'iot/sensor/data'
topic_pub = 'iot/response'

def on_connect(client, userdata, flags, rc):
    print(f'Connected to MQTT with code {rc}')
    client.subscribe(topic_sub)

def on_message(client, userdata, msg):
    try:
        data = json.loads(msg.payload)
        print(f'Received: {data}')

        valid_devices = ['esp32_1', 'esp32_2', 'esp32_3']
        if data['dev_id'] not in valid_devices:
            print(f'Invalid device: {data["dev_id"]}')
            return

        status = 'normal'
        if data['gas_level'] > 400 or data['rssi'] < -75:
            status = 'attack'

        if data['checksum'] != 255:
            print(f'Invalid checksum for {data["dev_id"]}')
            return

        try:
            response = requests.post('http://localhost:5000/analyze', json=data, timeout=5)
            ids_result = response.json().get('status', status)
        except Exception as e:
            print(f'IDS error: {e}')
            ids_result = status

        response_data = {
            'dev_id': data['dev_id'],
            'status': ids_result,
            'timestamp': int(time.time())
        }
        client.publish(topic_pub, json.dumps(response_data))
        print(f'Sent response: {response_data}')
    except Exception as e:
        print(f'Error processing message: {e}')

client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message
client.connect(broker, port)
client.loop_forever()
