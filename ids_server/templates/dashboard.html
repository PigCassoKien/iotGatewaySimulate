<!DOCTYPE html>
<html>
<head>
    <title>IoT NIDS Dashboard</title>
    <script src='https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt.js'></script>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        .attack { background-color: red; color: white; }
        .normal { background-color: green; color: white; }
    </style>
</head>
<body>
    <h1>IoT NIDS Dashboard</h1>
    <table id='dataTable'>
        <tr>
            <th>Device ID</th>
            <th>Timestamp</th>
            <th>Temperature (Â°C)</th>
            <th>Humidity (%)</th>
            <th>Gas Level</th>
            <th>Status</th>
        </tr>
        {% for item in data %}
        <tr class='{{ 'attack' if item.status == 'attack' else 'normal' }}'>
            <td>{{ item.dev_id }}</td>
            <td>{{ item.timestamp }}</td>
            <td>{{ item.temperature }}</td>
            <td>{{ item.humidity }}</td>
            <td>{{ item.gas_level }}</td>
            <td>{{ item.status }}</td>
        </tr>
        {% endfor %}
    </table>
    <script>
        const client = new Paho.MQTT.Client('localhost', 9001, 'web_client_' + Math.random().toString(16).slice(3));
        client.onMessageArrived = function(message) {
            const data = JSON.parse(message.payloadString);
            const table = document.getElementById('dataTable');
            const row = table.insertRow(1);
            row.className = data.status === 'attack' ? 'attack' : 'normal';
            row.innerHTML = `
                <td>${data.dev_id}</td>
                <td>${new Date(data.timestamp * 1000).toLocaleString()}</td>
                <td>${data.temperature || '-'}</td>
                <td>${data.humidity || '-'}</td>
                <td>${data.gas_level || '-'}</td>
                <td>${data.status}</td>
            `;
            if (table.rows.length > 11) table.deleteRow(-1);
        };
        client.onConnectionLost = function(responseObject) {
            console.log('Connection lost: ' + responseObject.errorMessage);
            setTimeout(() => client.connect({ onSuccess: onConnect }), 5000);
        };
        function onConnect() {
            console.log('Connected to MQTT via WebSocket');
            client.subscribe('iot/sensor/data');
            client.subscribe('iot/response');
        }
        client.connect({ onSuccess: onConnect });
    </script>
</body>
</html>